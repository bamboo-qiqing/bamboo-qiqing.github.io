import{_ as n}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as s,c as a,e as p}from"./app.b354d91e.js";const t={},e=p(`<h1 id="关闭连接" tabindex="-1"><a class="header-anchor" href="#关闭连接" aria-hidden="true">#</a> 关闭连接</h1><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不是必须的</span>
connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Connection 关闭会自动关闭 channel</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>AMQP 协议中的 Connection 和 channel 采用同样的方式管理网络失败、内部错误和显式关闭连接。他们的生命周期如下：</p><ul><li><p>Open：开启状态，当前对象可用</p></li><li><p>Closing：正在关闭状态</p><p>当前对象被显式调用关闭方法 <code>shutdown</code> 。</p></li><li><p>Closed：已经关闭状态</p><p>当前对象已经接收到所有的内部对象已完成关闭动作的通知，并且自己也关闭了。</p></li></ul><p>无论是程序正常调用关闭方法、客户端异常、网络异常等，Connection 和 channel 最终都会成为 Closed 状态。</p><h2 id="shutdownlistener" tabindex="-1"><a class="header-anchor" href="#shutdownlistener" aria-hidden="true">#</a> ShutdownListener</h2><p>与关闭相关的方法有：</p><ul><li><code>public void addShutdownListener(ShutdownListener listener);</code></li><li><code>public void removeShutdownListener(ShutdownListener listener);</code></li></ul><p>当 Connection 和 Channel 的状态变为 Closed 时会调用 shutdownListener；如果将一个 ShutdownListener 注册到已关闭的对象上，则会立即调用 shutdownListener</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ShutdownListener</span> <span class="token keyword">extends</span> <span class="token class-name">EventListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdownCompleted</span><span class="token punctuation">(</span><span class="token class-name">ShutdownSignalException</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>比如这个示例</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">addShutdownListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShutdownListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdownCompleted</span><span class="token punctuation">(</span><span class="token class-name">ShutdownSignalException</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;关闭原因：&quot;</span> <span class="token operator">+</span> cause<span class="token punctuation">.</span><span class="token function">getReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cause<span class="token punctuation">.</span><span class="token function">isHardError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;connection 异常&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;channel 异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 等待消费者回调后，关闭资源</span>
<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>10 秒后，调用 close 时，则会打印如下信息</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>关闭原因：#method&lt;channel.close&gt;(reply-code=200, reply-text=OK, class-id=0, method-id=0)
channel 异常
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>同时正在消费提交 ack 操作的线程都会异常；因为 channel 关闭了，再操作，肯定会异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">18.655</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token constant">ERROR</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>ForgivingExceptionHandler</span> <span class="token operator">-</span> <span class="token class-name">Consumer</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span></span>RabbitConsumer</span>$<span class="token number">1</span><span class="token annotation punctuation">@6533f373</span> <span class="token punctuation">(</span>amq<span class="token punctuation">.</span>ctag<span class="token operator">-</span><span class="token class-name">AmFm8HfjqayFInEYC3AliA</span><span class="token punctuation">)</span> method handleDelivery <span class="token keyword">for</span> channel <span class="token class-name">AMQChannel</span><span class="token punctuation">(</span>amqp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>admin<span class="token annotation punctuation">@192.168.4.250</span><span class="token operator">:</span><span class="token number">5672</span><span class="token operator">/</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> threw an exception <span class="token keyword">for</span> channel <span class="token class-name">AMQChannel</span><span class="token punctuation">(</span>amqp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>admin<span class="token annotation punctuation">@192.168.4.250</span><span class="token operator">:</span><span class="token number">5672</span><span class="token operator">/</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>AlreadyClosedException</span><span class="token operator">:</span> channel is already closed due <span class="token keyword">to</span> <span class="token namespace">clean</span> channel shutdown<span class="token punctuation">;</span> protocol method<span class="token operator">:</span> #method<span class="token generics"><span class="token punctuation">&lt;</span>channel<span class="token punctuation">.</span>close<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>reply<span class="token operator">-</span>code<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> reply<span class="token operator">-</span>text<span class="token operator">=</span><span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> method<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">ensureIsOpen</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">228</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">transmit</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">371</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">transmit</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">365</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>ChannelN</span><span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span><span class="token class-name">ChannelN</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1169</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>recovery<span class="token punctuation">.</span></span>RecoveryAwareChannelN</span><span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span><span class="token class-name">RecoveryAwareChannelN</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">89</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>recovery<span class="token punctuation">.</span></span>AutorecoveringChannel</span><span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span><span class="token class-name">AutorecoveringChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">436</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span></span>RabbitConsumer</span>$<span class="token number">1.</span><span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">RabbitConsumer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">52</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),o=[e];function c(l,u){return s(),a("div",null,o)}const r=n(t,[["render",c],["__file","06.html.vue"]]);export{r as default};
